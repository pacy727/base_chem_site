<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¢„É´„Éª„Éû„Çπ„Çø„Éº„Å∏„ÅÆÈÅì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
            overflow: hidden; /* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„Åü„ÇÅ */
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* --- „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ & „Ç®„Éï„Çß„ÇØ„Éà --- */
        #bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: 400% 400%;
            animation: gradient-bg 15s ease infinite;
            transition: background-image 1s ease-in-out;
        }

        @keyframes gradient-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fever-mode {
            animation: fever-pulse 0.7s infinite;
        }
        @keyframes fever-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            70% { box-shadow: 0 0 20px 30px rgba(255, 165, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
        }

        .feedback-correct { animation: feedback-correct-anim 0.5s ease; }
        @keyframes feedback-correct-anim {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 255, 255, 0); }
            50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255, 255, 255, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 255, 255, 0); }
        }
        .feedback-incorrect { animation: feedback-incorrect-anim 0.5s ease; }
        @keyframes feedback-incorrect-anim {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        
        #incorrect-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }
        .flash-active {
            animation: flash-anim 0.4s ease-out;
        }
        @keyframes flash-anim {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            animation: burst 1.5s ease-out forwards;
        }
        @keyframes burst {
            0% {
                transform: translate(var(--start-x), var(--start-y)) rotate3d(1, 1, 1, 0deg) scale(1);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotate3d(var(--rot-x), var(--rot-y), var(--rot-z), 720deg) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="bg-animation"></div>
    <div id="incorrect-flash"></div>

    <div id="game-container" class="w-full max-w-md mx-auto bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 transform transition-all relative">
        
        <header class="flex items-center justify-center mb-4 relative h-10">
            <button id="back-to-title-button" class="hidden absolute top-1/2 -translate-y-1/2 left-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded-lg text-sm transition-all">&lt; „Çø„Ç§„Éà„É´„Å∏</button>
            <h1 class="text-3xl font-extrabold text-blue-700">„É¢„É´„Éª„Éû„Çπ„Çø„Éº„Å∏„ÅÆÈÅì</h1>
        </header>

        <div id="status-bar" class="hidden justify-between items-center mb-4 bg-gray-50/80 p-3 rounded-lg">
            <div class="text-center">
                <span class="text-xs text-gray-500">SCORE</span>
                <p id="score" class="font-orbitron text-xl font-bold text-gray-800">0</p>
            </div>
            <div class="text-center">
                <span class="text-xs text-gray-500">Ê≠£Ëß£Êï∞</span>
                <p id="correct-count" class="font-orbitron text-xl font-bold text-green-600">0</p>
            </div>
            <div class="text-center">
                <span class="text-xs text-gray-500">ÂïèÈ°å</span>
                <p id="question-count" class="font-orbitron text-xl font-bold text-purple-600">1</p>
            </div>
            <div class="text-center">
                <span class="text-xs text-gray-500">TIME</span>
                <p id="timer" class="font-orbitron text-xl font-bold text-red-500">60</p>
            </div>
        </div>

        <div id="combo-display" class="h-6 mb-2 text-center transition-all">
            <span id="combo-text" class="text-xl font-bold text-orange-500 opacity-0 transform scale-0"></span>
        </div>
        
        <main id="main-content" class="bg-blue-50/80 border-2 border-blue-200 p-6 rounded-lg text-center min-h-[350px] flex flex-col justify-center">
            <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
            <div id="start-screen">
                <div class="flex justify-center mb-4">
                     <div class="text-5xl animate-bounce">üß™</div>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-4">ÊåëÊà¶„ÇíÂßã„ÇÅ„Çã„Åã„Å≠Ôºü</h2>
                
                <div class="flex justify-around w-full mb-4 space-x-2 md:space-x-4">
                    <div class="w-1/3 bg-white/50 p-3 rounded-lg text-center">
                        <h3 class="font-bold text-sm text-blue-800">Ëá™Â∑±„Éô„Çπ„Éà</h3>
                        <p id="high-score" class="font-orbitron text-2xl text-blue-600">0</p>
                    </div>
                    <div class="w-2/3 bg-white/50 p-3 rounded-lg h-32 overflow-y-auto">
                        <h3 class="font-bold text-sm text-center text-orange-800">„É©„É≥„Ç≠„É≥„Ç∞</h3>
                        <ol id="ranking-list" class="list-decimal list-inside text-sm text-left text-orange-700">
                            <li>Ë™≠„ÅøËæº„Åø‰∏≠...</li>
                        </ol>
                    </div>
                </div>

                <div class="bg-blue-100/80 text-left p-3 rounded-lg mb-6 text-sm text-gray-700">
                    <h3 class="font-bold text-center mb-2">„Äê„Ç≤„Éº„É†Ë™¨Êòé„Äë</h3>
                    <p>„ÉªÂà∂ÈôêÊôÇÈñì„ÅØ<span class="font-bold text-red-500">60Áßí</span>ÔºÅ</p>
                    <p>„ÉªÊ≠£Ëß£„Åß<span class="font-bold text-green-500">„Çπ„Ç≥„Ç¢UP</span>ÔºÜÊÆã„ÇäÊôÇÈñì<span class="font-bold text-blue-500">+3Áßí</span>ÔºÅ</p>
                    <p>„Éª‰∏çÊ≠£Ëß£„Å†„Å®ÊÆã„ÇäÊôÇÈñì<span class="font-bold text-red-600">-5Áßí</span>ÔºÅ</p>
                    <p>„ÉªÈÄ£Á∂öÊ≠£Ëß£„Åß<span class="font-bold text-orange-500">„Ç≥„É≥„Éú</span>ÔºÅ„Çπ„Ç≥„Ç¢„Åå„Å©„Çì„Å©„ÇìÂ¢ó„Åà„Çã„ÅûÔºÅ</p>
                </div>
                <button id="start-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">„Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ</button>
            </div>

            <!-- ÂïèÈ°åÁîªÈù¢ -->
            <div id="question-screen" class="hidden">
                <p class="text-sm text-gray-500 mb-2">„Äê„Éü„ÉÉ„Ç∑„Éß„É≥„Äë</p>
                <div id="question-text" class="text-xl font-bold text-gray-900 mb-4 h-24 flex flex-col items-center justify-center text-center"></div>
                <form id="answer-form">
                    <div id="normal-input-container" class="relative">
                        <input type="number" id="answer-input" step="any" class="w-full text-center text-2xl font-bold p-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition pr-16" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ..." autocomplete="off">
                        <p id="unit" class="absolute right-4 top-1/2 -translate-y-1/2 text-lg font-bold text-gray-500 pointer-events-none"></p>
                    </div>
                    <div id="scientific-input-container" class="hidden flex items-center justify-center space-x-2">
                        <input type="number" id="mantissa-input" step="any" class="w-1/2 text-center text-2xl font-bold p-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                        <span class="text-xl font-bold text-gray-700">√ó 10</span>
                        <input type="number" id="exponent-input" step="1" class="w-1/4 text-center text-2xl font-bold p-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" placeholder="ÊåáÊï∞">
                    </div>
                    <button type="submit" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transform hover:scale-105 transition-transform">Ëß£Á≠î„Åô„ÇãÔºÅ</button>
                </form>
            </div>

            <!-- ÁµêÊûúÁîªÈù¢ -->
            <div id="result-screen" class="hidden">
                 <h2 class="text-2xl font-bold text-red-500 mb-2">„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ</h2>
                <p class="text-gray-700">Âêõ„ÅÆÊúÄÁµÇ„Çπ„Ç≥„Ç¢„ÅØ...</p>
                <p id="final-score" class="font-orbitron text-6xl font-bold my-2 text-gray-800">0</p>
                
                <div class="flex justify-around text-center my-4 bg-white/50 p-3 rounded-lg">
                    <div>
                        <span class="text-sm font-bold text-gray-600">Ê≠£Ëß£Êï∞</span>
                        <p id="final-correct-count" class="font-orbitron text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div>
                        <span class="text-sm font-bold text-gray-600">ÂïèÈ°åÊï∞</span>
                        <p id="final-question-count" class="font-orbitron text-2xl font-bold text-purple-600">0</p>
                    </div>
                    <div>
                        <span class="text-sm font-bold text-gray-600">Ê≠£Á≠îÁéá</span>
                        <p id="final-accuracy" class="font-orbitron text-2xl font-bold text-blue-600">0.0%</p>
                    </div>
                </div>

                <p id="result-message" class="text-gray-600 font-semibold mb-4">Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ Ê¨°„ÅØÊõ¥„Å™„ÇãÈ´ò„Åø„Å∏ÔºÅ</p>
                
                <div id="new-highscore-form" class="hidden mb-4">
                    <p class="text-green-600 font-bold mb-2 animate-pulse">„É©„É≥„Ç≠„É≥„Ç∞ÂÖ•„ÇäÔºÅÂêçÂâç„ÇíË®òÈå≤„Åõ„ÇàÔºÅ</p>
                    <form id="save-score-form" class="flex space-x-2">
                        <input type="text" id="player-name-input" class="w-full text-center text-lg font-bold p-2 rounded-lg border-2 border-green-300 focus:border-green-500" placeholder="„Å™„Åæ„Åà" maxlength="8" required>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Ë®òÈå≤</button>
                    </form>
                </div>

                <div id="result-buttons" class="flex flex-col space-y-2">
                    <button id="restart-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ÔºÅ</button>
                </div>
                <button id="result-back-to-title-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-lg shadow-lg transform hover:scale-105 transition-transform">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
            </div>
        </main>
        
        <footer id="doctor-comment" class="mt-4 text-center min-h-[40px] flex items-center justify-center bg-gray-50/80 p-2 rounded-lg">
            <p id="doctor-text" class="text-gray-600">üë®‚Äçüî¨ „ÉØ„Ç∑„ÅåÂçöÂ£´„Åò„ÇÉ„ÄÇÂêõ„ÅÆÊåëÊà¶„ÇíÂæÖ„Å£„Å¶„Åä„Çã„Åû„ÄÇ</p>
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- DOMË¶ÅÁ¥†„ÅÆÂèñÂæó ---
        const gameContainer = document.getElementById('game-container');
        const bgAnimation = document.getElementById('bg-animation');
        const incorrectFlash = document.getElementById('incorrect-flash');
        const statusBar = document.getElementById('status-bar');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const correctCountEl = document.getElementById('correct-count');
        const questionCountEl = document.getElementById('question-count');
        const comboTextEl = document.getElementById('combo-text');
        
        const startScreen = document.getElementById('start-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultScreen = document.getElementById('result-screen');

        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const backToTitleButton = document.getElementById('back-to-title-button');
        const resultBackToTitleButton = document.getElementById('result-back-to-title-button');
        
        const questionTextEl = document.getElementById('question-text');
        const answerForm = document.getElementById('answer-form');
        const unitEl = document.getElementById('unit');

        const normalInputContainer = document.getElementById('normal-input-container');
        const answerInput = document.getElementById('answer-input');
        const scientificInputContainer = document.getElementById('scientific-input-container');
        const mantissaInput = document.getElementById('mantissa-input');
        const exponentInput = document.getElementById('exponent-input');

        const finalScoreEl = document.getElementById('final-score');
        const resultMessageEl = document.getElementById('result-message');
        const doctorTextEl = document.getElementById('doctor-text');

        const highScoreEl = document.getElementById('high-score');
        const rankingListEl = document.getElementById('ranking-list');
        const newHighscoreForm = document.getElementById('new-highscore-form');
        const saveScoreForm = document.getElementById('save-score-form');
        const playerNameInput = document.getElementById('player-name-input');
        const resultButtons = document.getElementById('result-buttons');
        
        // --- FirebaseÈñ¢ÈÄ£„ÅÆÂ§âÊï∞ ---
        let db, auth;
        let rankingData = [];
        let unsubscribeRanking; 

        // --- „Ç≤„Éº„É†„ÅÆÂü∫Êú¨Ë®≠ÂÆö ---
        const GAME_TIME = 60;
        const AVOGADRO_CONSTANT = 6.0e23;
        const MOLAR_VOLUME = 22.4;
        const HIGH_SCORE_KEY = 'moleMasterHighScore_v3_local';
        const RANKING_SIZE = 10; 

        const ATOMIC_MASSES = { H: 1.0, C: 12, N: 14, O: 16, Na: 23, Mg: 24, S: 32, Cl: 35.5, Ca: 40, Ne: 20, Al: 27, He: 4, Ar: 40, Fe: 56, Cu: 63.5, Ag: 108 };

        // --- „É¨„Éô„É´Âà•„Éá„Éº„Çø„Éó„Éº„É´ ---
        const molValues_L1 = [0.1, 0.5, 1.0, 1.5, 2.0, 5.0, 10];
        const molValues_L2 = [0.01, 0.02, 0.03, 0.05, 0.2, 0.25, 0.3, 2.5, 3.0, 4.0];
        const molValues_L3 = [0.04, 0.06, 0.07, 0.08, 0.09, 1.25, 0.4, 0.6, 0.7, 0.8, 0.9, 6.0, 7.0, 8.0, 9.0];

        const substances_L1 = [
            { name: 'Ê∞¥Á¥†', formula: 'H‚ÇÇ', molarMass: ATOMIC_MASSES.H * 2, state: 'gas' }, { name: 'ÁÇ≠Á¥†', formula: 'C', molarMass: ATOMIC_MASSES.C, state: 'solid' },
            { name: 'Á™íÁ¥†', formula: 'N‚ÇÇ', molarMass: ATOMIC_MASSES.N * 2, state: 'gas' }, { name: 'ÈÖ∏Á¥†', formula: 'O‚ÇÇ', molarMass: ATOMIC_MASSES.O * 2, state: 'gas' },
            { name: '„Éç„Ç™„É≥', formula: 'Ne', molarMass: ATOMIC_MASSES.Ne, state: 'gas' }, { name: '„Éä„Éà„É™„Ç¶„É†', formula: 'Na', molarMass: ATOMIC_MASSES.Na, state: 'solid' },
            { name: '„Éû„Ç∞„Éç„Ç∑„Ç¶„É†', formula: 'Mg', molarMass: ATOMIC_MASSES.Mg, state: 'solid' }, { name: '„Ç¢„É´„Éü„Éã„Ç¶„É†', formula: 'Al', molarMass: ATOMIC_MASSES.Al, state: 'solid' },
            { name: 'Ê∞¥', formula: 'H‚ÇÇO', molarMass: ATOMIC_MASSES.H * 2 + ATOMIC_MASSES.O, state: 'liquid' },
            { name: '„Ç¢„É≥„É¢„Éã„Ç¢', formula: 'NH‚ÇÉ', molarMass: ATOMIC_MASSES.N + ATOMIC_MASSES.H * 3, state: 'gas' },
            { name: '„É°„Çø„É≥', formula: 'CH‚ÇÑ', molarMass: ATOMIC_MASSES.C + ATOMIC_MASSES.H * 4, state: 'gas' },
            { name: '‰∫åÈÖ∏ÂåñÁÇ≠Á¥†', formula: 'CO‚ÇÇ', molarMass: ATOMIC_MASSES.C + ATOMIC_MASSES.O * 2, state: 'gas' },
        ];
        const substances_L2 = [
            { name: 'Â°©Á¥†', formula: 'Cl‚ÇÇ', molarMass: ATOMIC_MASSES.Cl * 2, state: 'gas' }, { name: 'Á°´ÈªÑ', formula: 'S', molarMass: ATOMIC_MASSES.S, state: 'solid' },
            { name: '„Éò„É™„Ç¶„É†', formula: 'He', molarMass: ATOMIC_MASSES.He, state: 'gas' }, { name: '„Ç¢„É´„Ç¥„É≥', formula: 'Ar', molarMass: ATOMIC_MASSES.Ar, state: 'gas' },
            { name: 'ÈâÑ', formula: 'Fe', molarMass: ATOMIC_MASSES.Fe, state: 'solid' }, { name: 'ÈäÖ', formula: 'Cu', molarMass: ATOMIC_MASSES.Cu, state: 'solid' },
            { name: 'Ê∞¥ÈÖ∏Âåñ„Éä„Éà„É™„Ç¶„É†', formula: 'NaOH', molarMass: ATOMIC_MASSES.Na + ATOMIC_MASSES.O + ATOMIC_MASSES.H, state: 'solid' },
            { name: '„Ç∞„É´„Ç≥„Éº„Çπ', formula: 'C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ', molarMass: ATOMIC_MASSES.C * 6 + ATOMIC_MASSES.H * 12 + ATOMIC_MASSES.O * 6, state: 'solid' },
            { name: 'Á°ùÈÖ∏', formula: 'HNO‚ÇÉ', molarMass: ATOMIC_MASSES.H + ATOMIC_MASSES.N + ATOMIC_MASSES.O * 3, state: 'aq' },
            { name: 'Á°´ÈÖ∏', formula: 'H‚ÇÇSO‚ÇÑ', molarMass: ATOMIC_MASSES.H * 2 + ATOMIC_MASSES.S + ATOMIC_MASSES.O * 4, state: 'aq' },
            { name: 'ÈÖ¢ÈÖ∏', formula: 'CH‚ÇÉCOOH', molarMass: ATOMIC_MASSES.C * 2 + ATOMIC_MASSES.H * 4 + ATOMIC_MASSES.O * 2, state: 'liquid' },
        ];
        const substances_L3 = [
            { name: 'Â∞øÁ¥†', formula: '(NH‚ÇÇ)‚ÇÇCO', molarMass: (ATOMIC_MASSES.N + ATOMIC_MASSES.H * 2) * 2 + ATOMIC_MASSES.C + ATOMIC_MASSES.O, state: 'solid' },
            { name: '‰∏ÄÈÖ∏ÂåñÁÇ≠Á¥†', formula: 'CO', molarMass: ATOMIC_MASSES.C + ATOMIC_MASSES.O, state: 'gas' },
            { name: 'ÁÇ≠ÈÖ∏„Ç´„É´„Ç∑„Ç¶„É†', formula: 'CaCO‚ÇÉ', molarMass: ATOMIC_MASSES.Ca + ATOMIC_MASSES.C + ATOMIC_MASSES.O * 3, state: 'solid' },
            { name: 'ÈÖ∏Âåñ„Éû„Ç∞„Éç„Ç∑„Ç¶„É†', formula: 'MgO', molarMass: ATOMIC_MASSES.Mg + ATOMIC_MASSES.O, state: 'solid' },
            { name: '‰∫åÈÖ∏ÂåñÁ°´ÈªÑ', formula: 'SO‚ÇÇ', molarMass: ATOMIC_MASSES.S + ATOMIC_MASSES.O * 2, state: 'gas' },
            { name: 'Á°´ÈÖ∏„Ç§„Ç™„É≥', formula: 'SO‚ÇÑ¬≤‚Åª', molarMass: ATOMIC_MASSES.S + ATOMIC_MASSES.O * 4, state: 'ion' },
            { name: 'Á°ùÈÖ∏„Ç§„Ç™„É≥', formula: 'NO‚ÇÉ‚Åª', molarMass: ATOMIC_MASSES.N + ATOMIC_MASSES.O * 3, state: 'ion' },
            { name: '„Ç®„Çø„É≥', formula: 'C‚ÇÇH‚ÇÜ', molarMass: ATOMIC_MASSES.C * 2 + ATOMIC_MASSES.H * 6, state: 'gas' },
            { name: '„Éó„É≠„Éë„É≥', formula: 'C‚ÇÉH‚Çà', molarMass: ATOMIC_MASSES.C * 3 + ATOMIC_MASSES.H * 8, state: 'gas' },
            { name: 'ÈÖ∏Âåñ„Ç¢„É´„Éü„Éã„Ç¶„É†', formula: 'Al‚ÇÇO‚ÇÉ', molarMass: ATOMIC_MASSES.Al * 2 + ATOMIC_MASSES.O * 3, state: 'solid' },
            { name: 'ÈÖ∏ÂåñÈâÑ(III)', formula: 'Fe‚ÇÇO‚ÇÉ', molarMass: ATOMIC_MASSES.Fe * 2 + ATOMIC_MASSES.O * 3, state: 'solid' },
            { name: 'ÈäÄ', formula: 'Ag', molarMass: ATOMIC_MASSES.Ag, state: 'solid' },
            { name: '„Ç®„Çø„Éé„Éº„É´', formula: 'C‚ÇÇH‚ÇÖOH', molarMass: ATOMIC_MASSES.C * 2 + ATOMIC_MASSES.H * 6 + ATOMIC_MASSES.O, state: 'liquid' },
        ];
        
        let score = 0, timeLeft = GAME_TIME, combo = 0, warmthLevel = 0, questionCount = 0, correctCount = 0;
        let timerInterval, currentCorrectAnswer = 0, isScientific = false, isFever = false;

        // --- FirebaseÂàùÊúüÂåñ„Å®Ë™çË®º ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                     apiKey: "AIzaSyCi8bGd1qt5QJNQKfqzWDRsgqdHZwLqdVs",
                     authDomain: "molmaster.firebaseapp.com",
                     projectId: "molmaster",
                     storageBucket: "molmaster.firebasestorage.app",
                     messagingSenderId: "8887697690",
                     appId: "1:8887697690:web:c65855cbbc8c994ae5eca3",
                     measurementId: "G-R2EQPP7822"}; 
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        loadTitleScreenData();
                    } else {
                        doctorTextEl.textContent = "üë®‚Äçüî¨ Ë™çË®º„Å´Â§±Êïó„Åó„Åü„Åû‚Ä¶„É™„É≠„Éº„Éâ„Åó„Å¶„Åø„Å¶„Åè„Çå„ÄÇ";
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                rankingListEl.innerHTML = '<li>Êé•Á∂ö„Ç®„É©„Éº</li>';
                doctorTextEl.textContent = "üë®‚Äçüî¨ „É©„É≥„Ç≠„É≥„Ç∞„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åü„Åû‚Ä¶";
            }
        }

        // --- ÁîªÈù¢ÈÅ∑Áßª & „Éá„Éº„Çø„É≠„Éº„Éâ ---
        function showScreen(screenId) {
            startScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');

            statusBar.classList.toggle('hidden', screenId !== 'question-screen');
            statusBar.classList.toggle('flex', screenId === 'question-screen');
            backToTitleButton.classList.toggle('hidden', screenId !== 'question-screen');
        }
        
        function resetToTitle() {
            clearInterval(timerInterval);
            score = 0; combo = 0; timeLeft = GAME_TIME; warmthLevel = 0; questionCount = 0; correctCount = 0;
            updateBackgroundColor(); updateScore(); updateTimer(); hideCombo(); endFeverMode();
            doctorTextEl.textContent = 'üë®‚Äçüî¨ „ÉØ„Ç∑„ÅåÂçöÂ£´„Åò„ÇÉ„ÄÇÂêõ„ÅÆÊåëÊà¶„ÇíÂæÖ„Å£„Å¶„Åä„Çã„Åû„ÄÇ';
            loadTitleScreenData();
            showScreen('start-screen');
        }

        // --- „Éá„Éº„Çø„Éè„É≥„Éâ„É™„É≥„Ç∞ (Firebase) ---
        function loadTitleScreenData() {
            const highScore = localStorage.getItem(HIGH_SCORE_KEY) || 0;
            highScoreEl.textContent = highScore;
            const rankingCollection = collection(db, 'artifacts', 'mole-master-game', 'public', 'data', 'ranking');
            const q = query(rankingCollection, orderBy("score", "desc"), limit(RANKING_SIZE));
            if(unsubscribeRanking) unsubscribeRanking();
            unsubscribeRanking = onSnapshot(q, (querySnapshot) => {
                rankingData = [];
                rankingListEl.innerHTML = '';
                querySnapshot.forEach((doc) => rankingData.push(doc.data()));
                if (rankingData.length > 0) {
                    rankingData.forEach(entry => {
                        const li = document.createElement('li');
                        li.textContent = `${entry.name} - ${entry.score} (${entry.correct}Âïè)`;
                        rankingListEl.appendChild(li);
                    });
                } else {
                    rankingListEl.innerHTML = '<li>„Åæ„Å†Ë™∞„ÇÇ„ÅÑ„Å™„ÅÑ„ÅûÔºÅ‰∏ÄÁï™‰πó„Çä„ÇíÁõÆÊåá„ÅõÔºÅ</li>';
                }
            }, (error) => {
                console.error("Ranking fetch failed: ", error);
                rankingListEl.innerHTML = '<li>Ë™≠„ÅøËæº„ÅøÂ§±Êïó</li>';
            });
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function initGame() {
            score = 0; timeLeft = GAME_TIME; combo = 0; warmthLevel = 0; questionCount = 0; correctCount = 0;
            questionCountEl.textContent = '1';
            correctCountEl.textContent = '0';
            updateBackgroundColor(); updateScore(); updateTimer(); hideCombo(); endFeverMode();
            showScreen('question-screen');
            doctorTextEl.textContent = 'üë®‚Äçüî¨ „Åï„ÅÇ„ÄÅÊúÄÂàù„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„Åò„ÇÉÔºÅ';
            generateQuestion();
            timerInterval = setInterval(countdown, 1000);
        }

        function generateQuestion() {
            questionCount++;
            questionCountEl.textContent = questionCount;
            
            let substancePool, molPool, substance;
            let answer = 0, unit = '';
            isScientific = false;
            questionTextEl.innerHTML = '';

            const rank = Math.floor(correctCount / 8) + 1;
            const rand = Math.random();

            if (rank === 1) { // 100% L1
                substancePool = substances_L1; molPool = molValues_L1;
            } else if (rank === 2) { // 50% L1, 50% L2
                if (rand < 0.5) { substancePool = substances_L1; molPool = molValues_L1; } 
                else { substancePool = substances_L2; molPool = molValues_L2; }
            } else if (rank === 3) { // 30% L1, 40% L2, 30% L3
                if (rand < 0.3) { substancePool = substances_L1; molPool = molValues_L1; } 
                else if (rand < 0.7) { substancePool = substances_L2; molPool = molValues_L2; } 
                else { substancePool = substances_L3; molPool = molValues_L3; }
            } else { // 50% L2, 50% L3
                if (rand < 0.5) { substancePool = substances_L2; molPool = molValues_L2; } 
                else { substancePool = substances_L3; molPool = molValues_L3; }
            }

            // --- ÂøúÁî®ÂïèÈ°å (20ÂïèÊ≠£Ëß£‰ª•Èôç) ---
            if (correctCount >= 20 && Math.random() < 0.3) {
                doctorTextEl.textContent = 'üë®‚Äçüî¨ Â∞ë„ÅóÈõ£„Åó„ÅÑÂïèÈ°å„Å´ÊåëÊà¶„Åò„ÇÉÔºÅ';
                let complexQuestionType = Math.floor(Math.random() * 6);
                const randomMol = molPool[Math.floor(Math.random() * molPool.length)];

                if ([0, 1, 4, 5].includes(complexQuestionType)) { // ‰ΩìÁ©ç„ÅåÁµ°„ÇÄÂïèÈ°å
                    const gasPool = substancePool.filter(s => s.state === 'gas');
                    if (gasPool.length > 0) {
                        substance = gasPool[Math.floor(Math.random() * gasPool.length)];
                    } else { // pool„Å´Ê∞ó‰Ωì„Åå„Å™„Åë„Çå„Å∞g„Å®ÂÄãÊï∞„ÅÆÂïèÈ°å„Å´Âº∑Âà∂Â§âÊõ¥
                        substance = substancePool[Math.floor(Math.random() * substancePool.length)];
                        complexQuestionType = 2; 
                    }
                } else {
                    substance = substancePool[Math.floor(Math.random() * substancePool.length)];
                }

                switch (complexQuestionType) {
                    case 0: // g -> L
                        const massForL = randomMol * substance.molarMass;
                        questionTextEl.innerHTML = `<div>${massForL.toPrecision(3)} g „ÅÆ ${substance.name}(${substance.formula}) „ÅØÊ®ôÊ∫ñÁä∂ÊÖã„Åß</div><div>‰ΩïL„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * MOLAR_VOLUME; unit = 'L'; break;
                    case 1: // L -> g
                        const volumeForG = randomMol * MOLAR_VOLUME;
                        questionTextEl.innerHTML = `<div>Ê®ôÊ∫ñÁä∂ÊÖã„Åß ${volumeForG.toPrecision(3)} L „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰Ωïg„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * substance.molarMass; unit = 'g'; break;
                    case 2: // g -> particles
                        const massForP = randomMol * substance.molarMass;
                        questionTextEl.innerHTML = `<div>${massForP.toPrecision(3)} g „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰ΩïÂÄã„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * AVOGADRO_CONSTANT; isScientific = true; break;
                    case 3: // particles -> g
                        const particlesForG = randomMol * AVOGADRO_CONSTANT;
                        const [mantG, expG] = particlesForG.toExponential(1).split('e+');
                        questionTextEl.innerHTML = `<div class="leading-none"><span class="font-orbitron text-3xl">${mantG}</span><span class="mx-1 text-2xl">√ó</span><span class="font-orbitron text-3xl">10<sup>${expG}</sup></span><span class="ml-2 text-xl">ÂÄã„ÅÆ</span></div><div>${substance.name}(${substance.formula}) „ÅØ‰Ωïg„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * substance.molarMass; unit = 'g'; break;
                    case 4: // L -> particles
                        const volumeForP = randomMol * MOLAR_VOLUME;
                        questionTextEl.innerHTML = `<div>Ê®ôÊ∫ñÁä∂ÊÖã„Åß ${volumeForP.toPrecision(3)} L „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰ΩïÂÄã„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * AVOGADRO_CONSTANT; isScientific = true; break;
                    case 5: // particles -> L
                        const particlesForL = randomMol * AVOGADRO_CONSTANT;
                        const [mantL, expL] = particlesForL.toExponential(1).split('e+');
                        questionTextEl.innerHTML = `<div class="leading-none"><span class="font-orbitron text-3xl">${mantL}</span><span class="mx-1 text-2xl">√ó</span><span class="font-orbitron text-3xl">10<sup>${expL}</sup></span><span class="ml-2 text-xl">ÂÄã„ÅÆ</span></div><div>${substance.name}(${substance.formula}) „ÅØÊ®ôÊ∫ñÁä∂ÊÖã„Åß‰ΩïL„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * MOLAR_VOLUME; unit = 'L'; break;
                }
            } else {
                // --- ÈÄöÂ∏∏ÂïèÈ°å (molÂ§âÊèõ) ---
                substance = substancePool[Math.floor(Math.random() * substancePool.length)];
                let questionType;
                do {
                    questionType = Math.floor(Math.random() * 6);
                } while ((questionType === 2 || questionType === 3) && (substance.state !== 'gas'));
                
                const randomMol = molPool[Math.floor(Math.random() * molPool.length)];
                const answerMol = molPool[Math.floor(Math.random() * molPool.length)];

                switch (questionType) {
                    case 0:
                        questionTextEl.innerHTML = `<div>${randomMol} mol „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰Ωïg„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * substance.molarMass; unit = 'g'; break;
                    case 1:
                        const randomMass = answerMol * substance.molarMass;
                        questionTextEl.innerHTML = `<div>${randomMass.toPrecision(3)} g „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰Ωïmol„Åã„Å≠Ôºü</div>`;
                        answer = answerMol; unit = 'mol'; break;
                    case 2:
                        questionTextEl.innerHTML = `<div>${randomMol} mol „ÅÆ ${substance.name}(${substance.formula}) „ÅØÊ®ôÊ∫ñÁä∂ÊÖã„Åß</div><div>‰ΩïL„Åã„Å≠Ôºü</div>`;
                        answer = randomMol * MOLAR_VOLUME; unit = 'L'; break;
                    case 3:
                        const randomVolume = answerMol * MOLAR_VOLUME;
                        questionTextEl.innerHTML = `<div>Ê®ôÊ∫ñÁä∂ÊÖã„Åß ${randomVolume.toPrecision(3)} L „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰Ωïmol„Åã„Å≠Ôºü</div>`;
                        answer = answerMol; unit = 'mol'; break;
                    case 4:
                        const q4Mol = molPool[Math.floor(Math.random() * molPool.length)];
                        questionTextEl.innerHTML = `<div>${q4Mol} mol „ÅÆ ${substance.name}(${substance.formula}) „ÅØ</div><div>‰ΩïÂÄã„Åã„Å≠Ôºü</div>`;
                        answer = q4Mol * AVOGADRO_CONSTANT; isScientific = true; break;
                    case 5:
                        const numParticles = answerMol * AVOGADRO_CONSTANT;
                        const [mant, exp] = numParticles.toExponential(1).split('e+');
                        questionTextEl.innerHTML = `<div class="leading-none"><span class="font-orbitron text-3xl">${mant}</span><span class="mx-1 text-2xl">√ó</span><span class="font-orbitron text-3xl">10<sup>${exp}</sup></span><span class="ml-2 text-xl">ÂÄã„ÅÆ</span></div><div>${substance.name}(${substance.formula}) „ÅØ‰Ωïmol„Åã„Å≠Ôºü</div>`;
                        answer = answerMol; unit = 'mol'; break;
                }
            }
            
            currentCorrectAnswer = parseFloat(answer.toPrecision(3));
            normalInputContainer.classList.toggle('hidden', isScientific);
            scientificInputContainer.classList.toggle('hidden', !isScientific);
            unitEl.textContent = `(${unit})`;
            answerInput.value = ''; mantissaInput.value = ''; exponentInput.value = '';
            
            if (isScientific) {
                exponentInput.value = '23';
                mantissaInput.focus();
            } else {
                answerInput.focus();
            }
        }

        function checkAnswer(e) {
            e.preventDefault();
            let userAnswer;
            if (isScientific) {
                const mantissa = parseFloat(mantissaInput.value); const exponent = parseFloat(exponentInput.value);
                if (isNaN(mantissa) || isNaN(exponent)) return;
                userAnswer = mantissa * Math.pow(10, exponent);
            } else {
                userAnswer = parseFloat(answerInput.value);
                if (isNaN(userAnswer)) return;
            }
            if (Math.abs(userAnswer - currentCorrectAnswer) <= currentCorrectAnswer * 0.025) handleCorrectAnswer(); // Ë®±ÂÆπË™§Â∑Æ„Çí2.5%„Å´Â∞ë„ÅóÁ∑©Âíå
            else handleIncorrectAnswer();
        }

        function handleCorrectAnswer() {
            createParticles(); combo++;
            correctCount++;
            correctCountEl.textContent = correctCount;
            const rank = Math.floor(correctCount / 8) + 1;
            let scoreToAdd = 100 + (combo * 10) + ((rank - 1) * 20); // „É©„É≥„ÇØ„Éú„Éº„Éä„Çπ
            if (isFever) scoreToAdd *= 3;
            score += scoreToAdd;
            timeLeft = Math.min(GAME_TIME + 10, timeLeft + 3);
            if (warmthLevel < BACKGROUND_COLORS.length - 1) { warmthLevel++; updateBackgroundColor(); }
            updateScore(); updateTimer(); showCombo();
            doctorTextEl.textContent = `üë®‚Äçüî¨ Ê≠£Ëß£„Åò„ÇÉÔºÅ„ÇÑ„Çã„Å™ÔºÅ +${scoreToAdd}ÁÇπÔºÅ`;
            gameContainer.classList.add('feedback-correct');
            setTimeout(() => gameContainer.classList.remove('feedback-correct'), 500);
            if (combo === 5 && !isFever) startFeverMode();
            generateQuestion();
        }

        function handleIncorrectAnswer() {
            combo = 0; timeLeft -= 5;
            if(timeLeft < 0) timeLeft = 0;
            warmthLevel = 0; updateBackgroundColor();
            hideCombo(); updateTimer(); endFeverMode();
            incorrectFlash.classList.add('flash-active');
            setTimeout(() => incorrectFlash.classList.remove('flash-active'), 400);
            const correctAnswerText = currentCorrectAnswer > 1e5 ? currentCorrectAnswer.toExponential(1) : currentCorrectAnswer.toPrecision(3);
            doctorTextEl.textContent = `üë®‚Äçüî¨ „ÇÄ„ÇÄ„Å£„ÄÅÈÅï„ÅÜ„ÅûÔºÅÁ≠î„Åà„ÅØ ${correctAnswerText} „Åò„ÇÉ„Å£„Åü„ÄÇ`;
            gameContainer.classList.add('feedback-incorrect');
            setTimeout(() => gameContainer.classList.remove('feedback-incorrect'), 500);
            if (timeLeft > 0) generateQuestion(); else endGame();
        }
        
        function endGame() {
            clearInterval(timerInterval);
            showScreen('result-screen');
            finalScoreEl.textContent = score;

            const finalCorrectCountEl = document.getElementById('final-correct-count');
            const finalQuestionCountEl = document.getElementById('final-question-count');
            const finalAccuracyEl = document.getElementById('final-accuracy');

            const attemptedQuestions = questionCount > 1 ? questionCount - 1 : 0;
            const accuracy = attemptedQuestions > 0 ? (correctCount / attemptedQuestions) * 100 : 0;

            finalCorrectCountEl.textContent = correctCount;
            finalQuestionCountEl.textContent = attemptedQuestions;
            finalAccuracyEl.textContent = accuracy.toFixed(1) + '%';
            
            const personalBest = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
            if (score > personalBest) localStorage.setItem(HIGH_SCORE_KEY, score);
            const worstScoreInRanking = rankingData.length < RANKING_SIZE ? 0 : rankingData[rankingData.length-1].score;
            // if (score > 0 && score >= worstScoreInRanking) {
            //     newHighscoreForm.classList.remove('hidden');
            //     resultButtons.classList.add('hidden');
            // } else {
            //     newHighscoreForm.classList.add('hidden');
            //     resultButtons.classList.remove('hidden');
            // }

            // Â∏∏„Å´„Äå„Çø„Ç§„Éà„É´„Å∏Êàª„Çã„Äç„ÅØË°®Á§∫
            document.getElementById('result-back-to-title-button').classList.remove('hidden');

            if (score > 0 && score >= worstScoreInRanking) {
                // „É©„É≥„Ç≠„É≥„Ç∞ÂÖ•„Çä„Åó„ÅüÂ†¥Âêà
                newHighscoreForm.classList.remove('hidden'); // ÂêçÂâçÂÖ•Âäõ„ÇíË°®Á§∫
                resultButtons.classList.add('hidden'); // „Äå„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Äç„ÇíÈùûË°®Á§∫
            } else {
                // „É©„É≥„Ç≠„É≥„Ç∞Â§ñ„ÅÆÂ†¥Âêà
                newHighscoreForm.classList.add('hidden'); // ÂêçÂâçÂÖ•Âäõ„ÇíÈùûË°®Á§∫
                resultButtons.classList.remove('hidden'); // „Äå„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Äç„ÇíË°®Á§∫
            }
            
            let message = '';
            if (score > 4000) message = 'Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÂêõ„ÅØ„ÇÇ„ÅÜ„É¢„É´„Éª„Éû„Çπ„Çø„Éº„Åò„ÇÉÔºÅ';
            else if (score > 2000) message = '„Çà„Åè„ÇÑ„Å£„ÅüÔºÅ„Å™„Åã„Å™„Åã„ÅÆËÖïÂâç„Åò„ÇÉ„Å™„ÄÇ';
            else if (score > 800) message = '„Åæ„Åö„Åæ„Åö„Åò„ÇÉ„Å™„ÄÇÁ∑¥Áøí„Åô„Çå„Å∞„ÇÇ„Å£„Å®‰º∏„Å≥„Çã„ÅûÔºÅ';
            else message = '„Åæ„Å†„Åæ„Å†‰øÆË°å„ÅåË∂≥„Çä„Çì„ÅÆ„ÅÜ„ÄÇÂÜçÊåëÊà¶„Åò„ÇÉÔºÅ';
            resultMessageEl.textContent = message;
            doctorTextEl.textContent = `üë®‚Äçüî¨ ${message}`;
        }

        async function saveScore(e) {
            e.preventDefault();
            const playerName = playerNameInput.value.trim();
            if (!playerName) return;
            const submitButton = saveScoreForm.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Ë®òÈå≤‰∏≠...';
            try {
                const rankingCollection = collection(db, 'artifacts', 'mole-master-game', 'public', 'data', 'ranking');
                await addDoc(rankingCollection, { 
                    name: playerName, 
                    score: score, 
                    questions: questionCount,
                    correct: correctCount,
                    createdAt: new Date()
                });
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("„Çπ„Ç≥„Ç¢„ÅÆË®òÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            } finally {
                newHighscoreForm.classList.add('hidden');
                resultButtons.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Ë®òÈå≤';
            }
        }

        function countdown() {
            timeLeft--;
            updateTimer();
            if (timeLeft <= 0) endGame();
        }

        const BACKGROUND_COLORS = [
            'linear-gradient(45deg, #e0c3fc, #8ec5fc, #6a82fb, #fcb69f)','linear-gradient(45deg, #d299c2, #fef9d7, #a1c4fd, #c2e9fb)','linear-gradient(45deg, #ff9a9e, #fecfef, #ffdde1, #ee9ca7)','linear-gradient(45deg, #fbc2eb, #a6c1ee, #f093fb, #f5576c)','linear-gradient(45deg, #fccb90, #d57eeb, #f83600, #f9d423)','linear-gradient(45deg, #ff7e5f, #feb47b, #f6d365, #fda085)','linear-gradient(45deg, #f09819, #edde5d, #ff512f, #dd2476)','linear-gradient(45deg, #eb3349, #f45c43, #ff4e50, #f9d423)'
        ];
        function updateBackgroundColor() { bgAnimation.style.backgroundImage = BACKGROUND_COLORS[warmthLevel]; }
        function updateScore() { scoreEl.textContent = score; }
        function updateTimer() {
            timerEl.textContent = timeLeft;
            timerEl.classList.toggle('text-yellow-500', timeLeft <= 20 && timeLeft > 10);
            timerEl.classList.toggle('text-red-500', timeLeft <= 10);
            timerEl.classList.toggle('animate-pulse', timeLeft <= 10 && timeLeft > 0);
        }
        function showCombo() {
            if (combo >= 2) {
                comboTextEl.textContent = isFever ? `üî• FEVER! ${combo} COMBO!` : `${combo} COMBO!`;
                comboTextEl.classList.remove('opacity-0', 'scale-0');
                comboTextEl.classList.add('opacity-100', 'scale-100');
            }
        }
        function hideCombo() {
            comboTextEl.classList.remove('opacity-100', 'scale-100');
            comboTextEl.classList.add('opacity-0', 'scale-0');
        }
        function startFeverMode() {
            isFever = true;
            gameContainer.classList.add('fever-mode');
            doctorTextEl.textContent = 'üë®‚Äçüî¨ üî•„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†Á™ÅÂÖ•„Åò„ÇÉÔºÅ„ÉÅ„É£„É≥„Çπ„Åò„ÇÉ„ÅûÔºÅ';
            setTimeout(endFeverMode, 7000);
        }
        function endFeverMode() { isFever = false; gameContainer.classList.remove('fever-mode'); }

        const PARTICLE_COLORS = ['#FFD700', '#FFA500', '#FF6347', '#FFFFFF', '#87CEEB', '#98FB98', '#f9a', '#a9f'];
        function createParticles() {
            const answerBtn = answerForm.querySelector('button');
            const rect = answerBtn.getBoundingClientRect();
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div'); p.className = 'particle';
                const isRect = Math.random() > 0.2;
                const width = Math.random() * 10 + 5;
                const height = isRect ? Math.random() * 5 + 5 : width;
                p.style.width = `${width}px`; p.style.height = `${height}px`;
                p.style.backgroundColor = PARTICLE_COLORS[Math.floor(Math.random() * PARTICLE_COLORS.length)];
                const x = rect.left + rect.width / 2; const y = rect.top + rect.height / 2;
                const angle = Math.random() * 360; const distance = Math.random() * 120 + 60;
                const endX = Math.cos(angle * Math.PI / 180) * distance;
                const endY = Math.sin(angle * Math.PI / 180) * distance + 40;
                p.style.setProperty('--start-x', `${x}px`); p.style.setProperty('--start-y', `${y}px`);
                p.style.setProperty('--end-x', `${x + endX}px`); p.style.setProperty('--end-y', `${y + endY}px`);
                p.style.setProperty('--rot-x', `${Math.random() * 2 - 1}`);
                p.style.setProperty('--rot-y', `${Math.random() * 2 - 1}`);
                p.style.setProperty('--rot-z', `${Math.random() * 2 - 1}`);
                p.style.animationDuration = `${Math.random() * 0.8 + 1.0}s`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1800);
            }
        }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº & ÂàùÊúüÂåñ ---
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', initGame);
        backToTitleButton.addEventListener('click', resetToTitle);
        resultBackToTitleButton.addEventListener('click', resetToTitle);
        answerForm.addEventListener('submit', checkAnswer);
        saveScoreForm.addEventListener('submit', saveScore);

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            updateBackgroundColor();
        });
    </script>
</body>
</html>

